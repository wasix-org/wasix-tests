#!/usr/bin/expect -f
set timeout 15
# We need to use expect to be able to write to /dev/tty

set cmd [lrange $argv 0 end]
eval spawn $cmd

proc expect_or_fail {pattern} {
    expect {
        $pattern {}
        timeout  { puts "Timeout waiting for '$pattern'"; exit 1 }
        eof      { puts "Process ended too early"; exit 1 }
    }
}

# TODO: It could also print the receiving of token 1 after posting token 5
expect_or_fail "main: posting token 1"
expect_or_fail "worker: got token 1"

expect_or_fail "main: posting token 5"
expect_or_fail "worker: got token 5"
expect_or_fail "done."

set result [wait]
set exit_status [lindex $result 3]
exit $exit_status